<% layout("/layouts/boilerplate") %>
    <div class="row mt-3">
    <div class="col-8 offset-2">
    
    <h3>Edit new Listing</h3>
    <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" class="needs-validation" novalidate enctype="multipart/form-data">
        <div class="mb-3">
        <label for="title" class="form-label">Title:</label>
        <input type="text" id="title" name="listing[title]" value="<%= listing.title %>" class="form-control" required><br>
        <div class="invalid-feedback">
            Please provide a title for the listing.
        </div>
    </div> 
         
         <div class="mb-3">
        <label for="description" class="form-label">Description:</label>
        <textarea id="description" name="listing[description]" class="form-control" required><%= listing.description %></textarea><br>
        <div class="invalid-feedback">
            Please provide a description for the listing.
            </div>
    </div> 

    <div class="mb-3">
        <label for="image-preview" class="form-label">Current Image:</label><br>
        <img src="<%= originalImageUrl %>" width="200"> 
    </div>    

    <div class="mb-3">
        <label for="image" class="form-label">Upload New Image:</label>
        <input type="file" id="image" name="listing[image]"  class="form-control"><br>
       
    </div>

    <div class="row">
        <div class="mb-3 col-md-4">   
        <label for="price" class="form-label">Price (INR):</label>
        <input type="number" id="price" name="listing[price]" value="<%= listing.price %>" class="form-control" required><br>
        <div class="invalid-feedback">
            Please provide a price for the listing.
        </div>
    </div> 

    <div class="mb-3 col-md-8">
        <label for="locationInput" class="form-label">Location:</label>
        <input type="text" id="locationInput" name="listing[location]" value="<%= listing.location %>" class="form-control" required><br>
        </div>
        <div class="invalid-feedback">
            Please provide a location for the listing.
        </div>
    </div>
    <!-- üìç Live Map Preview -->
<div class="mb-4">
  <div id="map" style="height:300px; border-radius:12px;"></div>
</div>



    <div class="mb-3">
        <label for="country" class="form-label">Country:</label>
        <input type="text" id="country" name="listing[country]" value="<%= listing.country %>" class="form-control" required><br>
        <div class="invalid-feedback">
            Please provide a country for the listing.
        </div>
    </div>   

        <button class="btn btn-dark edit-btn mb-3">Edit</button>
    </form>
    </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
  'use strict';

  const forms = document.querySelectorAll('.needs-validation');

  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
});
</script>

<script>
 window.initialCoordinates = <%- JSON.stringify(coordinates) %>;

</script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const mapDiv = document.getElementById("map");
  const input = document.getElementById("locationInput");
  if (!mapDiv || !input) return;

  // Default location (India center fallback)
  let coords = window.initialCoordinates || [78.9629, 20.5937];

  const map = L.map("map").setView([coords[1], coords[0]], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);


  
  let marker = L.marker([coords[1], coords[0]]).addTo(map);

   marker.bindPopup(`
    <b><%= listing.title %></b><br>
    <%= listing.location %>
  `).openPopup();

  // üîÅ Debounce (avoid too many API calls)
  let timeout = null;

  input.addEventListener("input", () => {
    clearTimeout(timeout);

    timeout = setTimeout(async () => {
      const query = input.value.trim();
      if (!query) return;

      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`
        );
        const data = await res.json();

        if (!data.length) return;

        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);

        marker.setLatLng([lat, lon]);
        map.setView([lat, lon], 10);
      } catch (err) {
        console.error("Geocoding failed", err);
      }
    }, 800); // ‚è± waits until typing stops
  });
});
</script>

   
